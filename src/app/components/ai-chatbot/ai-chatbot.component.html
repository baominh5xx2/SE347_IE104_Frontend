<div class="agent-overlay" (click)="onClose()">
  <div class="agent-dialog" (click)="$event.stopPropagation()">
    <aside class="agent-sidebar">
      <div class="sidebar-header">
        <div class="agent-brand">
          <div class="agent-icon">
            <i class="fas fa-compass"></i>
          </div>
          <div>
            <h2>Travel Agent</h2>
            <p>Trợ lý du lịch thông minh</p>
          </div>
        </div>
        <button class="icon-button" (click)="onClose()" title="Đóng">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="sidebar-controls">
        <button class="primary-button" (click)="startNewConversation()" [disabled]="isStreaming">
          <i class="fas fa-plus"></i>
          Cuộc trò chuyện mới
        </button>
      </div>

      <div class="sidebar-section-label">Lịch sử trò chuyện</div>
      <div class="conversation-list" role="list">
        @if (!conversations.length) {
          <div class="conversation-empty">
            <i class="fas fa-comments"></i>
            <p>Bắt đầu trò chuyện để lưu lịch sử tại đây.</p>
          </div>
        } @else {
          @for (conversation of conversations; track conversation.id) {
            <div
              class="conversation-item"
              role="button"
              tabindex="0"
              [class.active]="conversation.id === activeConversation?.id"
              (click)="selectConversation(conversation.id)"
              (keydown.enter)="selectConversation(conversation.id)"
              (keydown.space)="$event.preventDefault(); selectConversation(conversation.id)"
            >
              <div class="conversation-meta">
                <div class="conversation-title">{{ conversation.title }}</div>
              </div>
              <div class="conversation-preview">{{ getConversationPreview(conversation) }}</div>
              <button
                type="button"
                class="conversation-delete"
                title="Xóa cuộc trò chuyện"
                (click)="$event.stopPropagation(); deleteConversation(conversation.id)"
                [disabled]="isStreaming"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          }
        }
      </div>
    </aside>

    <section class="agent-stage">
      <header class="stage-header">
        <div class="stage-heading">
          <div class="stage-icon">
            <i class="fas fa-robot"></i>
          </div>
          <div>
            <h1>Travel Intelligence</h1>
            <p>Định hướng kế hoạch du lịch cá nhân hoá</p>
          </div>
        </div>
        <div class="stage-actions">
          <div class="status-chip" [class.error]="headerStatus === 'Error'">
            <span class="status-dot"></span>
            {{ headerStatus }}
          </div>
        </div>
      </header>

      <div class="stage-body">
        <div class="messages-container" #messagesContainer>
          @if (!messages.length && !isTyping) {
            <div class="stage-empty">
              <div class="empty-illustration">
                <i class="fas fa-map-marked-alt"></i>
              </div>
              <h2>Xin chào! Tôi có thể giúp gì cho hành trình tiếp theo của bạn?</h2>
              <p>Đặt câu hỏi về điểm đến, ngân sách, ưu đãi hoặc bất kỳ điều gì liên quan đến tour.</p>
            </div>
          }

          @for (message of messages; track $index) {
            <div class="message-row" [class.user]="message.isUser" [class.assistant]="!message.isUser">
              @if (message.isError) {
                <div class="message-error">
                  <i class="fas fa-exclamation-triangle"></i>
                  <span [innerHTML]="message.content"></span>
                </div>
              } @else {
                <div class="message-body">
                  <div class="message-avatar">
                    @if (message.isUser) {
                      <i class="fas fa-user"></i>
                    } @else {
                      <i class="fas fa-robot"></i>
                    }
                  </div>
                  <div class="message-bubble" [innerHTML]="message.isUser ? message.content : formatMessageContent(message.content)"></div>
                </div>
              }

              @if (!message.isUser && message.tourSelections?.length) {
                <div class="tour-selection-deck">
                  @for (tourSelection of message.tourSelections; track tourSelection.index) {
                    <div class="tour-selection-card">
                      <div class="tour-selection-heading">
                        <h3>{{ tourSelection.name }}</h3>
                        <span>{{ formatPrice(tourSelection.price) }}</span>
                      </div>
                      <div class="tour-selection-actions">
                        <button class="pill-button primary" (click)="selectTour(tourSelection.name, tourSelection.price.toString())">
                          <i class="fas fa-check"></i>
                          Chọn tour này
                        </button>
                        <button class="pill-button ghost" (click)="viewTourDetails(tourSelection.name)">
                          <i class="fas fa-eye"></i>
                          Xem chi tiết
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }

              @if (!message.isUser && message.tours?.length) {
                <div class="tour-carousel">
                  @for (tour of message.tours; track $index) {
                    <div class="tour-card">
                      <div class="tour-card-header">
                        <div>
                          <h4>{{ tour.package_name || 'Tour Package' }}</h4>
                          @if (tour.package_id) {
                            <span>ID: {{ tour.package_id }}</span>
                          }
                        </div>
                        <div class="tour-card-price">
                          <small>Giá từ</small>
                          <strong>{{ formatPrice(tour.price || 0) }}</strong>
                        </div>
                      </div>
                      <div class="tour-card-body">
                        <div class="tour-attribute">
                          <i class="fas fa-map-marker-alt"></i>
                          <span>{{ tour.destination || 'Đang cập nhật' }}</span>
                        </div>
                        <div class="tour-attribute">
                          <i class="fas fa-clock"></i>
                          <span>{{ tour.duration_days || 0 }} ngày</span>
                        </div>
                        <div class="tour-attribute">
                          <i class="fas fa-plane"></i>
                          <span>{{ tour.departure_location || 'Đang cập nhật' }}</span>
                        </div>
                        @if (tour.start_date || tour.end_date) {
                          <div class="tour-attribute">
                            <i class="fas fa-calendar-alt"></i>
                            <span>
                              @if (tour.start_date && tour.end_date) {
                                {{ formatDate(tour.start_date) }} - {{ formatDate(tour.end_date) }}
                              } @else if (tour.start_date) {
                                Bắt đầu: {{ formatDate(tour.start_date) }}
                              } @else if (tour.end_date) {
                                Kết thúc: {{ formatDate(tour.end_date) }}
                              }
                            </span>
                          </div>
                        }
                      </div>
                      <div class="tour-card-actions">
                        <button class="pill-button primary" (click)="navigateToTourDetail(tour.package_id)" [disabled]="!tour.package_id">
                          <i class="fas fa-info-circle"></i>
                          Xem chi tiết
                        </button>
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          }

          @if (isTyping) {
            <div class="message-row assistant">
              <div class="message-body">
                <div class="message-avatar">
                  <i class="fas fa-robot"></i>
                </div>
                <div class="typing-ellipsis">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
              </div>
            </div>
          }
        </div>
      </div>

      <footer class="stage-composer">
        <div class="composer-bar">
          <textarea
            #messageInput
            [(ngModel)]="userMessage"
            (keydown)="onKeyDown($event)"
            (input)="onTextareaInput($event)"
            placeholder="Đặt câu hỏi về hành trình, điểm đến hay các ưu đãi du lịch..."
            rows="1"
          ></textarea>
          <div class="composer-actions">
            <button class="send-button" type="button" (click)="sendMessage()" [disabled]="isStreaming || !userMessage.trim()">
              Gửi
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
        </div>
      </footer>
    </section>
  </div>
</div>